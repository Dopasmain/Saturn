<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="/js/common.js"></script>
    <script src="/js/particles.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="/index.css" />
    <link rel="stylesheet" href="/styles/loader.css">
    <link rel="stylesheet" href="/styles/template.css">
    <meta name="googlebot" content="index, follow, snippet" />
    <link rel="shortcut icon" content="favicon.ico" />
    <script src="/baremux/index.js" defer></script>
    <script src="/epoxy/index.js" defer></script>
    <script src="/libcurl/index.js" defer></script>
    <script src="/uv/uv.bundle.js" defer></script>
    <script src="/uv/uv.config.js" defer></script>
    <script src="/js/uv/register-sw.js" defer></script>
    <script src="/js/uv/search.js" defer></script>
  </head>
<body>
   <div id="canvas-container"></div>
    <div class="grain-overlay"></div>

  <div id="particles-js"></div>
  
  <div class="content">
    <div class="main">
      <div id="preload">
        <div class="spinner-container">
          <div class="spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
          </div>
          <div class="loading-text-wrapper">
            <span class="loading-letter">L</span>
            <span class="loading-letter">O</span>
            <span class="loading-letter">A</span>
            <span class="loading-letter">D</span>
            <span class="loading-letter">I</span>
            <span class="loading-letter">N</span>
            <span class="loading-letter">G</span>
          </div>
        </div>
      </div>
      
      <div id="frameHolder"></div>
    </div>
  </div>

  <script src="../js/canvas.js"></script>
</body>
<script>
const qs = window.top.location.search;
const urlParams = new URLSearchParams(qs);

let src = urlParams.get('src');
let type = urlParams.get('type');
let title = urlParams.get('title');

document.getElementById('preload').remove();

async function registerServiceWorker(url){
  let connection = new BareMux.BareMuxConnection("/baremux/worker.js")

  try {
    await registerSW();
  } catch (err) {
    console.error(err)
  }

  let wispUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/wisp/";
  if (!localStorage.getItem('proxy-transport')){
    await connection.setTransport("/libcurl/index.mjs", [{ wisp: wispUrl }]);
  } else{
    console.log("Setting transport to " + localStorage.getItem('proxy-transport'))
    if (localStorage.getItem('proxy-transport') === "Epoxy"){
      await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
    }
    if (localStorage.getItem('proxy-transport') === "Libcurl"){
      await connection.setTransport("/libcurl/index.mjs", [{ wisp: wispUrl }]);
    }
  }
}

function createAndAppend(){
  let container = document.createElement('div');
  container.className = 'iframe-container';

  let o = document.createElement('iframe');
  o.setAttribute('id','objFrame');
  o.setAttribute('class','objFrame');
  o.setAttribute('allow','keyboard *');
  o.setAttribute('src',loadGame());

  let bottomBar = document.createElement('div');
  bottomBar.className = 'bottom-bar';

  let titleEl = document.createElement('div');
  titleEl.className = 'bottom-title';
  titleEl.textContent = title;

  let buttonGroup = document.createElement('div');
  buttonGroup.className = 'button-group';

let popoutBtn = document.createElement('button');
popoutBtn.className = 'frame-action-btn';
popoutBtn.innerHTML = '<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';
popoutBtn.onclick = function() { window.open(loadGame(),'_blank'); };

let fullscreenBtn = document.createElement('button');
fullscreenBtn.className = 'frame-action-btn';
fullscreenBtn.innerHTML = '<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>';
fullscreenBtn.onclick = function() { document.getElementById('objFrame').requestFullscreen(); };

  buttonGroup.appendChild(popoutBtn);
  buttonGroup.appendChild(fullscreenBtn);

  bottomBar.appendChild(titleEl);
  bottomBar.appendChild(buttonGroup);

  container.appendChild(o);
  container.appendChild(bottomBar);

  document.getElementById('frameHolder').appendChild(container);
}

const xorEncode = {
    encode(str) {
        if (!str) return str;
        return encodeURIComponent(
            str
                .toString()
                .split('')
                .map((char, ind) =>
                    ind % 2 ? String.fromCharCode(char.charCodeAt() ^ 2) : char
                 )
                .join('')
        );
    }
};

function loadGame(){
  let returnValue
  if (type == 'html'){
    returnValue = `/files/games${src}`
  } else if (type == 'flash'){
    returnValue = `/files/embeds/ruffle.html?src=${src}`
  } else if (type == 'proxy'){
    returnValue = `/@/` + xorEncode.encode(src)
  } else if (type == 'method'){
    returnValue = `/files/methods${src}`
  }else{
    returnValue = `/files/embeds/emujs/index.html?game=${src}&?core=${type}`
  }
  return returnValue;
}

function onPageLoad() {
  createAndAppend();
  if (type == 'proxy'){registerServiceWorker();}
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', onPageLoad);
} else {
  onPageLoad();
}
</script>
</html>