<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="/js/common.js"></script>
    <script src="/js/particles.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/index.css" />
    <link rel="stylesheet" href="/styles/loader.css">
    <link rel="stylesheet" href="/styles/template.css">
    <link rel="stylesheet" href="/styles/proxy.css">
    <!-- Ultr@v!0l3t -->
    <meta name="googlebot" content="index, follow, snippet" />
    <link rel="shortcut icon" content="favicon.ico" />
    <script src="/uv/uv.bundle.js" defer></script>
    <script src="/uv/uv.config.js" defer></script>
    <script src="/js/uv/register-sw.js" defer></script>
    <script src="/js/uv/search.js" defer></script>
    <script src="/js/uv/index.js" defer></script>
    <!-- Ultr@v!0l3t -->
  </head>

  <script src="/baremux/index.js"></script>
  <script src="/libcurl/index.js"></script>
  <script src="/epoxy/index.js"></script>
  <script>
    
    let _connection = new BareMux.BareMuxConnection("/baremux/worker.js");
    async function setConnection(arg){
      const wispUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/wisp/";
      switch (arg){
        case 1:
          await _connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          localStorage.setItem('proxy-transport','Epoxy');
          break;
        case 2:
          await _connection.setTransport("/libcurl/index.mjs", [{ wisp: wispUrl }]);
          localStorage.setItem('proxy-transport','Libcurl');
          break;
      }
    }
    if (!localStorage.getItem('proxy-transport')){
      setConnection(1);
    } else {
      if (localStorage.getItem('proxy-transport') === "Epoxy") setConnection(1);
      if (localStorage.getItem('proxy-transport') === "Libcurl") setConnection(2);
    }

    
    async function goTo(url){
      try {
        if (typeof registerSW === 'function') {
          await registerSW();
        }
      } catch (err) {
        const error = document.getElementById('uv-error');
        const errorCode = document.getElementById('uv-error-code');
        if (error) error.textContent = "Failed to register service worker.";
        if (errorCode) errorCode.textContent = err.toString();
        console.error(err);
      }
      const frame = document.getElementById("uv-frame");
      frame.style.display = "block";
      frame.src = __uv$config.prefix + __uv$config.encodeUrl(url);
    }
  </script>

  <body>
    
    <form id="topbar-form" onsubmit="return false;" style="display:none"></form>

    <div class="utilityBar">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none"
           style="position: absolute; z-index: 2147483646; left: calc(2.5rem + 9.63px); top: calc(3.633em);">
        <path d="M30 0H0V30C0 30 -1.11468e-05 18.2353 8.86364 9.11765C17.7273 0 30 0 30 0Z" fill="#161616"/>
      </svg>

      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none"
           style="position: absolute; z-index: 2147483639; left: calc(2.5rem + 9.83px); top: calc(3.633em + 0.1px); filter: blur(0.75px); transition: none !important;">
        <path d="M30 0H0V30C0 30 -1.11468e-05 18.2353 8.86364 9.11765C17.7273 0 30 0 30 0Z"
              stroke="rgba(66, 66, 66, 0.86)" stroke-width="2"/>
      </svg>

      <ul class="utility">
        <li>
          <div class="utilityIcon backButton">
            <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
          </div>
        </li>
        <li>
          <div class="utilityIcon refreshButton">
            <svg viewBox="0 0 24 24">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
          </div>
        </li>
        <li>
          <div class="utilityIcon forwardButton">
            <svg viewBox="0 0 24 24">
              <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
            </svg>
          </div>
        </li>
        <hr style="min-width: 1px" />
        <div class="search-header" style="flex-grow: 1; margin-left: 8px; margin-right: 8px">
          <input
            placeholder="Enter search or web address"
            class="search-header__input"
            id="proxy"
            type="text"
            style="flex-grow: 1"
            form="topbar-form"
          />
          <div class="webSecurityIcon" title=""></div>
          <button
            aria-label="search"
            style="user-select: none; cursor: default; position: absolute; margin-left: 7px; margin-bottom: -2px;"
            type="button"
            class="search-header__button"
          >
            <svg fill="none" viewBox="0 0 18 18" height="18" width="18" class="search-header__icon">
              <path
                fill="#3A3A3A"
                d="M7.132 0C3.197 0 0 3.124 0 6.97c0 3.844 3.197 6.969 7.132 6.969 1.557 0 2.995-.49 4.169-1.32L16.82 18 18 16.847l-5.454-5.342a6.846 6.846 0 0 0 1.718-4.536C14.264 3.124 11.067 0 7.132 0zm0 .82c3.48 0 6.293 2.748 6.293 6.15 0 3.4-2.813 6.149-6.293 6.149S.839 10.37.839 6.969C.839 3.568 3.651.82 7.132.82z"
              ></path>
            </svg>
          </button>
        </div>
        <hr style="margin-left: 43px; min-width: 1px" />
        <li>
          <div class="utilityIcon homeButton">
            <svg viewBox="0 0 24 24">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
          </div>
        </li>
        <li>
          <div class="utilityIcon erudaButton" onclick="inspectelement()">
            <svg viewBox="0 0 24 24">
              <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0L19.2 12l-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
            </svg>
          </div>
        </li>
        <li>
          <div class="utilityIcon fullscreenButton">
            <svg viewBox="0 0 24 24">
              <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
          </div>
        </li>
        <li>
          <div class="utilityIcon settingsButton" style="margin-right: 14px">
           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings2-icon lucide-settings-2"><path d="M14 17H5"/><path d="M19 7h-9"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>
          </div>
        </li>
      </ul>
    </div>

    <div style="animation-delay: 0.5s; position: absolute; height:100vh; width: 100vw; z-index: 1000;" id="particles-js"></div>
    <script src="/js/load-particles.js"></script>
    <script src="/js/particles.min.js"></script>

    <iframe id="uv-frame" style="display: none; background-color: white; position: absolute; margin: 0; border: 0; padding: 0; width: 100vw; height: 100vh; z-index: 10000;"></iframe>

    <div class="content">
      <div class="main">
        <div style="z-index: 9999; display: flex;flex-direction: column; height: 100%; width: 100%; justify-content: center; align-items: center;">
          <h1 style="font-size: 48px; text-shadow: 0px 0px 25px white; padding:20px;">
            Search
          </h1>
          <div style="height: 10px;"></div>
          <form 
              style="width: 100vw; display: flex; justify-content: center; align-items: center;"
              id="uv-form"
              class="flex-center"
            >
            <input
              id="uv-search-engine"
              value="https://duckduckgo.com/search?q=%s"
              type="hidden"
            />
            <input
              style="text-align: center; margin: 15px;"
              autocomplete="off"
              id="uv-address" 
              type="text" 
              placeholder="Search or Enter a Url"
            />
          </form>
          <div style="height: 10px;"></div>
          <div class="desc left-margin">
            <p id="uv-error"></p>
            <pre id="uv-error-code"></pre>
          </div>
          <div style="overflow: visible;">
            <img onclick="goTo('https://duckduckgo.com')" src="/files/thumbs/duckduckgo.png">
            <img onclick="goTo('https://now.gg')" src="/files/thumbs/nowgg.png">
            <img onclick="goTo('https://tiktok.com')" src="/files/thumbs/tiktok.png">
            <img onclick="goTo('https://spotify.com')" src="/files/thumbs/spotify.png">
          </div>
          <div style="overflow: visible;">
            <img onclick="goTo('https://github.com')" src="/files/thumbs/github.png">
            <img onclick="goTo('https://play.geforcenow.com/mall')" src="/files/thumbs/geforcenow.png">
            <img onclick="goTo('https://discord.com')" src="/files/thumbs/discord.png">
            <img onclick="goTo('https://soundcloud.com')" src="/files/thumbs/soundcloud.png">
          </div>
        </div>
      </div>
    </div>
    
    

    <script>
      function inspectelement() {
        console.log("Inspect element clicked");
      }

      window.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('proxy');
        const btn = document.querySelector('.search-header__button');
        const frame = document.getElementById('uv-frame');
        const searchEngineInput = document.getElementById('uv-search-engine');
        const uvAddress = document.getElementById('uv-address');
        const securityIcon = document.querySelector('.webSecurityIcon');

        const getEngine = () =>
          (searchEngineInput && searchEngineInput.value) || 'https://duckduckgo.com/search?q=%s';

        const hasProtocol = (q) => /^https?:\/\//i.test(q);

        const isProbablyUrl = (q) => {
          if (hasProtocol(q)) return true;
          if ((q || '').includes(' ')) return false;
          return (
            /^[\w-]+(\.[\w-]+)+(:\d+)?(\/.*)?$/i.test(q) ||
            /^localhost(:\d+)?(\/.*)?$/i.test(q)
          );
        };

        const buildUrl = (q) => {
          q = (q || '').trim();
          if (!q) return null;
          if (hasProtocol(q)) return q;
          if (isProbablyUrl(q)) return 'https://' + q;
          const engine = getEngine();
          return engine.replace('%s', encodeURIComponent(q));
        };

        const updateSecurityIcon = (rawUrl) => {
          if (!securityIcon) return;
          try {
            const u = new URL(rawUrl);
            const secure = u.protocol === 'https:';
            securityIcon.title = secure ? 'Secure (HTTPS)' : 'Not secure (HTTP)';
          } catch {
            securityIcon.title = '';
          }
        };

        const handleSearch = async () => {
          const q = input.value;
          const url = buildUrl(q);
          if (!url) return;
          if (uvAddress) uvAddress.value = q;
          updateSecurityIcon(url);
          try {
            await goTo(url);
          } catch (e) {
            console.error(e);
            alert('Не удалось открыть: ' + url);
          }
        };

        if (btn) {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            handleSearch();
          });
        }

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault(); // не перезагружаем страницу
            handleSearch();
          }
        });

        // Навигационные кнопки
        const on = (sel, event, fn) => {
          const el = document.querySelector(sel);
          if (el) el.addEventListener(event, fn);
        };

        on('.backButton', 'click', () => {
          try {
            if (frame?.contentWindow?.history) frame.contentWindow.history.back();
          } catch {}
        });

        on('.forwardButton', 'click', () => {
          try {
            if (frame?.contentWindow?.history) frame.contentWindow.history.forward();
          } catch {}
        });

        on('.refreshButton', 'click', () => {
          try {
            if (frame?.contentWindow?.location) frame.contentWindow.location.reload();
            else if (frame) frame.src = frame.src;
          } catch {
            if (frame) frame.src = frame.src;
          }
        });

        on('.homeButton', 'click', () => {
          // Hide the iframe first
          if (frame) {
            frame.style.display = 'none';
            frame.src = 'about:blank';
          }
          // Force redirect of the top-level window
          setTimeout(() => {
            window.top.location.replace('/');
          }, 100);
        });

        on('.settingsButton', 'click', () => {
          // Hide the iframe first
          if (frame) {
            frame.style.display = 'none';
            frame.src = 'about:blank';
          }
          // Force redirect to settings page
          setTimeout(() => {
            window.top.location.replace('/s.html#Proxy');
          }, 100);
        });

        on('.fullscreenButton', 'click', async () => {
          try {
            if (!document.fullscreenElement) {
              if (frame && frame.requestFullscreen) await frame.requestFullscreen();
              else await document.documentElement.requestFullscreen();
            } else {
              await document.exitFullscreen();
            }
          } catch (e) {
            console.error('Fullscreen error', e);
          }
        });
      });
    </script>
  </body>
</html>